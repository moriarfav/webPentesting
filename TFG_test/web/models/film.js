var url = 'mongodb://localhost:27017/peliculas';
var MongoClient = require('mongodb').MongoClient;
module.exports = {
    // insertar peliculas de ejemplo en MongoDB
    insertFirst: function(){
        MongoClient.connect(url, function (err, db) {
            if (err) {
                console.log(err);
            }
            var collection = db.collection('films');
            collection.insert([
                        { titulo: 'El caballero oscuro', director: 'Christopher Nolan', genero: ["Thriller", "Accion", "Drama"], sinopsis: "Batman/Bruce Wayne (Christian Bale) regresa para continuar su guerra contra el crimen. Con la ayuda del teniente Jim Gordon (Gary Oldman) y del Fiscal del Distrito Harvey Dent (Aaron Eckhart), Batman se propone destruir el crimen organizado en la ciudad de Gotham. El triunvirato demuestra su eficacia, pero, de repente, aparece Joker (Heath Ledger), un nuevo criminal que desencadena el caos y tiene aterrados a los ciudadanos. (FILMAFFINITY)", puntuacion: 8.1 },
                        { titulo: 'Origen', director: 'Christopher Nolan', genero: ["Ciencia ficcion", "Thriller", "Accion"], sinopsis: "Dom Cobb (DiCaprio) es un experto en el arte de apropiarse, durante el sueño, de los secretos del subconsciente ajeno. La extraña habilidad de Cobb le ha convertido en un hombre muy cotizado en el mundo del espionaje, pero también lo ha condenado a ser un fugitivo y, por consiguiente, a renunciar a llevar una vida normal. Su única oportunidad para cambiar de vida será hacer exactamente lo contrario de lo que ha hecho siempre: la incepción, que consiste en implantar una idea en el subconsciente en lugar de sustraerla. Sin embargo, su plan se complica debido a la intervención de alguien que parece predecir cada uno de sus movimientos, alguien a quien sólo Cobb podrá descubrir. (FILMAFFINITY)", puntuacion: 8 },
                        { titulo: 'Infiltrados', director: 'Martin Scorsese', genero: ["Thriller", "Accion", "Drama"], sinopsis: "El Departamento de Policía de Massachussets se enfrenta a la mayor banda de crimen organizado de la ciudad de Boston. La estrategia consiste en acabar desde dentro con Frank Costello, el poderoso jefe de la mafia irlandesa (Jack Nicholson). El encargado de infiltrarse en la banda es un joven novato, Billy Costigan (Leonardo DiCaprio). Mientras Billy intenta ganarse la confianza de Costello, otro joven policía, Colin Sullivan (Matt Damon), sube rápidamente de categoría y ocupa un puesto en la unidad de Investigaciones Especiales, grupo de élite cuya misión también es acabar con Costello. Lo que nadie sabe es que Colin es un topo infiltrado en la policía por el propio Costello. (FILMAFFINITY)", puntuacion: 7.9 
                        },
                        {titulo:'SecretFilm28'}
                    ], function (err) {
                        if (err){
                         console.log(err);
                        }
                        console.log("datos de peliculas insertados");
                    });
        });

    },
    // encontrar peliculas por titulo
    getFilms: function(titulo, callback){
        MongoClient.connect(url, function (err, db) {
            if (err) {
                console.log(err);
            }
            var collection = db.collection('films');
            collection.find({ titulo: {$in:[titulo]} }).toArray(function (err, docs) {
                 if (err) {
                    console.log(err);
                }
                 callback(err,docs);
            });
        });
    }, // encontrar una pelicula por su titutlo
    getFilm: function(titulo, callback){
        MongoClient.connect(url, function (err, db) {
            if (err) {
                console.log(err);
            }
            var collection = db.collection('films');
            collection.findOne({ titulo: {$in:[titulo]} },function(err,docs){
                 if (err) {
                    console.log(err);
                }
                 callback(err,docs);
            });
        });
    },  // encontrar todas las peliculas a excepcion de la oculta
    getAll: function(callback){
        MongoClient.connect(url, function (err, db) {
            if (err) {
                console.log(err);
            }
            var collection = db.collection('films');
            collection.find({ titulo: {$ne:'SecretFilm28'} }).limit(15).toArray(function (err, docs) {
                if (err) {
                console.log(err);
            }
                callback(err,docs);
            });
        });
    }, // consulta vulnerable que busca peliculas por su titulo
    mongoQuery: function(titulo,callback){
        MongoClient.connect(url, function (err, db) {
            if (err) {
                console.log(err);
            }
            var collection = db.collection('films');
            var query = { titulo: titulo}
            //var query = {titulo: {$in:[titulo]}}   // utilizando un selecctor
                collection.find(query).toArray(function (err, docs) {
                    if (err) {
                        console.log(err);
                    }
                    callback(err,docs);
                });
        });
    }
}            